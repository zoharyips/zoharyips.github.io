---
layout: post
title: Java - String ç±»
categories: Java
keywords: Java
date: 2019-10-26 11:37:30
mathjax: true
prism: [java, bash]
---

Java æä¾›äº†é»˜è®¤çš„å­—ç¬¦ä¸²ç±» (String)ï¼Œæœ¬æ–‡ä¸»è¦è®°è¿°äº†å…¶åŸºæœ¬ç”¨æ³•å’Œéœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼Œæœ¬æ–‡å¿½ç•¥å·²è¿‡æ—¶æˆ–æœ‰å…³ Unicode çš„æ–¹æ³•

* TOC
{:toc}

## 1. â€œStringå¯¹è±¡â€ã€€ä¸æ˜¯ã€€â€œå­—ç¬¦ä¸²â€

1. äº‹å®ä¸Š String å¯¹è±¡å¹¶ä¸ç­‰äºå­—ç¬¦ä¸²ï¼ŒçœŸæ­£ä»£è¡¨å­—ç¬¦ä¸²çš„æ˜¯ String å¯¹è±¡ä¸­çš„ç§æœ‰å¸¸æ•°ç»„ï¼š `private final char value[]`)ï¼›ç”±äº String ç±»æ˜¯ä¸€ä¸ª**å€¼ç±»**ï¼ˆä¸€ä¸ªå®ä¾‹å¯¹è±¡ä»…èƒ½ä»£è¡¨ä¸€ä¸ªå€¼ï¼‰ï¼ŒåŠ ä¸Šä½¿ç”¨ä¹ æƒ¯ï¼Œæˆ‘ä»¬é€šå¸¸å°† String å¯¹è±¡ç§°ä¸º **å­—ç¬¦ä¸²**

    ```java
    /** The value is used for character storage. */
    private final char value[];
    ```

2. ç”±äº String ä½¿ç”¨ç§æœ‰çš„å¸¸å­—ç¬¦æ•°ç»„æ¥ä¿å­˜å­—ç¬¦ä¸²å†…å®¹ï¼Œ**å› æ­¤æ¯ä¸ª String å¯¹è±¡åœ¨åˆå§‹åŒ–åéƒ½æ— æ³•æ”¹å˜ `value[]` è¿™ä¸ªå­—ç¬¦ä¸²ï¼ŒString å¯¹è±¡æ˜¯ä¸å¯å˜çš„**ï¼›  
    é‚£ä½ æˆ–è®¸ä¼šç–‘æƒ‘ï¼šé‚£æˆ‘ä¹‹å‰å¯ä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥ã€åˆ å‡å·¥ä½œå‘€ï¼Ÿå­—ç¬¦ä¸²æ€ä¹ˆä¼šæ˜¯ä¸å¯å˜çš„å‘¢ï¼Ÿ  
    å‘å‡ºè¿™æ ·ç–‘é—®çš„åŸå› æ˜¯ä½ å¯¹äº java å˜é‡è®¤è¯†ä¸å¤Ÿæ·±åˆ»ï¼Œçœ‹ä¸€ä¸ªä¾‹å­ï¼š

    ```java
    String str = "Hello World!";       // hashCodeï¼š-969099747
    String newStr = str;               // hashCodeï¼š-969099747
    System.out.println(str == newStr); // true
    str += " Man";                     // hashCodeï¼š1318721719
    newStr.hashCode();                 // hashCodeï¼š-969099747
    System.out.println(str == newStr); // false
    ```

    `str` ä¸ `newStr` å…¶å®åªæ˜¯ä¸¤ä¸ª**å¼•ç”¨**ï¼Œæœ€åˆæŒ‡å‘åŒä¸€ç‰‡åœ°å€ç©ºé—´ï¼›`str` è¿›è¡Œæ‹¼æ¥æ“ä½œåï¼Œ`str` ä¸ `newStr` æŒ‡å‘äº†ä¸åŒåœ°å€ï¼Œè€Œ `newStr` æŒ‡å‘çš„å¯¹è±¡å´æ²¡å˜ï¼›è¡¨æ˜åœ¨æ‹¼æ¥è¿‡åï¼Œ`str` ä¸å†æ˜¯åŸæ¥é‚£ä¸ªå¯¹è±¡äº†ï¼Œè€Œæ˜¯ JVM é‡æ–°åœ¨å¸¸é‡æ± ä¸­åˆ›å»º String å¯¹è±¡ï¼ˆ"Hello World! Man"ï¼‰ï¼Œå†å°† `str` æŒ‡å‘æ–°çš„å¯¹è±¡ï¼ŒåŸæœ¬çš„å¯¹è±¡ï¼ˆ"Hello World!"ï¼‰æ˜¯ä¸å˜çš„ã€‚

3. ç”±äºå­—ç¬¦ä¸²åæ˜¯ä¸ªå¼•ç”¨ï¼Œå› æ­¤å½“å¼•ç”¨æ²¡æŒ‡å‘å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œè°ƒç”¨å…¶ç›¸å…³æ–¹æ³•å°†å‘ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå¦‚:

    ```java
    String str = null;
    System.out.printf(str.hashCode()); // NullPointerException!
    ```

## 2. Stringçš„å”¯ä¸€æ€§åˆ¤æ–­

* ä½¿ç”¨ `==` åˆ¤æ–­ä¸¤ä¸ªå­—ç¬¦ä¸²å¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œå³å¯¹è±¡çš„ **å†…å­˜åœ°å€** æ˜¯å¦ç›¸ç­‰

* String é‡å†™ `equals()` æ–¹æ³•ï¼šé€ä¸ªå­—ç¬¦å¯¹æ¯”åˆ¤æ–­å­—ç¬¦ä¸²å¯¹è±¡çš„ **å†…å®¹** æ˜¯å¦ç›¸ç­‰

* String é‡å†™ `hashCode()` æ–¹æ³•ï¼šç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²ç®—å‡ºæ¥çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œé String å¯¹è±¡çš„åœ°å€ç©ºé—´

çœ‹å®Œäº†ä¸Šæ–‡ï¼Œä½ æˆ–è®¸åˆä¼šæœ‰ç–‘æƒ‘äº†ï¼šæ—¢ç„¶ String å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªå­—ç¬¦ä¸²ä¸æ˜¯ä¼šæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡å—ï¼Ÿé‚£åˆ¤æ–­å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸ç­‰ï¼Œç›´æ¥ç”¨ `==` åˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡å°±è¡Œäº†ï¼Ÿå¹²å˜›è¦é‡å†™ `equals()` æ–¹æ³•å‘¢ï¼Ÿ

å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```java
String str0 = new String("abc");
String str1 = "abc";
String str2 = String.valueOf("abc");

System.out.println(str0.equals(str1));  // true
System.out.println(str2.equals(str1));  // true
System.out.println(str0 == str1);       // false
System.out.println(str2 == str1);       // true
```

!["é»‘äººé—®å·"](/images/posts/black_guy_quotation.png "What the F**K")

åˆ«æ€¥ï¼Œå®¢å®˜å¬æˆ‘é“æ¥ï¼š

`str0` è¿™ä¸ªå¼•ç”¨åˆ›å»ºæ—¶ï¼Œåˆ†ä¸¤æ­¥ï¼š

1. JVM åœ¨å¸¸é‡æ± ä¸­æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ "abc" è¿™ä¸€å¯¹è±¡ï¼Œå‘ç°æ²¡æœ‰ï¼ˆä¹‹å‰æ²¡åˆ›å»ºè¿‡ï¼‰ï¼Œå°±åœ¨å¸¸é‡æ± ä¸­åˆ›å»ºäº†ä¸€ä¸ª "abc" å¯¹è±¡ã€‚

2. ç”±äº `str0` ä½¿ç”¨æ„é€ å‡½æ•°æ˜¾ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå› æ­¤ JVM æ ¹æ®æ„é€ å‡½æ•°åœ¨å †ä¸­ new äº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå…¶å†…å®¹ä¸ "abc" å¯¹è±¡ç›¸åŒï¼ˆæƒ³ä¸åˆ°å§ï¼Œæˆ‘è¯´å®ƒä¸å¯å˜åˆæ²¡è¯´ä»–ä¸èƒ½æœ‰é‡å¤çš„ï¼‰

`str1` è¿™ä¸ªå¼•ç”¨åˆ›å»ºæ—¶ï¼šJVM å‘ç°å¸¸é‡æ± ä¸­å·²ç»æœ‰ "abc" è¿™ä¸ªå¯¹è±¡ï¼Œå°±ç›´æ¥å°† `str1` æŒ‡å‘äº†å®ƒã€‚

`str2` è¿™ä¸ªå¼•ç”¨åˆ›å»ºè¿‡ç¨‹å¾—çœ‹ä¸€çœ‹ `String.valueOf(String str)` æ–¹æ³•ï¼š

```java
// String.java
public static String valueOf(Object obj) {
    return (obj == null) ? "null" : obj.toString();
}

public String toString() {
    return this;
}
```

`String.valueOf("abc")` æ—¶è°ƒç”¨äº† `"abc".toString()` æ–¹æ³•ä½œä¸ºè¿”å›å€¼ï¼Œè€Œ String é‡å†™äº† `toString()` æ–¹æ³•ç›´æ¥è¿”å›è‡ªèº«ï¼Œæ‰€ä»¥  

```java
String str2 = String.valueOf("abc"); // ç­‰åŒäº String str2 = "abc";
```  

å› æ­¤ï¼Œ`str2` åŒæ ·æŒ‡å‘å¸¸é‡æ± çš„ "abc" å¯¹è±¡ï¼Œå› æ­¤ `str1 == str2`ï¼›

ç›¸åŒçš„å­—ç¬¦ä¸²å¯èƒ½ä¼šè½åœ¨ä¸åŒçš„å¯¹è±¡ä¸­ï¼Œæ‰€ä»¥ï¼Œç¼–å†™ String ç±»çš„å¼€å‘è€…å¸Œæœ›æˆ‘ä»¬ä½¿ç”¨ `==` æ˜¯å¦ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨ `equals()` å’Œ `hashCode()` æ¥åˆ¤æ–­å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸ç­‰ã€‚

åŒæ—¶ï¼Œç”±äºå­—ç¬¦ä¸²å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæˆ‘ä»¬åº”è¯¥ç…§ä»–çš„æŒ‡ç¤ºï¼Œå°†ç›¸åŒçš„å­—ç¬¦ä¸²å¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ˆè¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºä½ æ”¹å˜äº†å­—ç¬¦ä¸²çš„å€¼ï¼Œå°±ä¼šè‡ªåŠ¨æŒ‡å‘å…¶ä»–å¯¹è±¡ï¼Œä¸ä¼šæ”¹å˜åˆ°åŸæ¥çš„å¯¹è±¡ï¼‰ï¼Œè€Œåƒä¸‡ä¸è¦ç”¨æ„é€ æ–¹æ³•çš„æ–¹å¼æ¥åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼

```java
String str1 = new String("Hello world");     // ç¦æ­¢ âŒï¼ï¼ï¼
String str2 = "Hello world";                 // æ¨è âœ”
String str3 = String.valueOf("Hello world"); // ä¸æ¨è
String str4 = String.valueOf(1315.520);      // æ¨è âœ”
```

## 3. è¿æ¥å­—ç¬¦ä¸²

* ä½¿ç”¨ `+` è¿æ¥äºŒå­—ç¬¦ä¸²

    ä½¿ç”¨æ­¤æ“ä½œç¬¦è¿›è¡Œå­—ç¬¦ä¸²è¿æ¥ï¼Œæ— è®ºè¿æ¥çš„å³æ“ä½œæ•°æ˜¯å¦ä¸ºç©ºï¼Œéƒ½å°†è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼ˆå³ä½¿è¯¥æ–°å­—ç¬¦ä¸²ä¸åŸå­—ç¬¦ä¸²ä¸€æ ·ï¼‰

* ä½¿ç”¨ `concat(String str)` æ–¹æ³•è¿æ¥äºŒå­—ç¬¦ä¸²

    ä½¿ç”¨ `concat(String str)` æ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²è¿æ¥æ—¶ï¼Œè‹¥ä¼ å…¥çš„æ˜¯ nullï¼Œåˆ™å°†æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå› ä¸ºå†…éƒ¨è°ƒç”¨äº†è¯¥å‚æ•°çš„ length æ–¹æ³•ï¼›åŒæ—¶ï¼Œè‹¥ä¼ å…¥çš„æ˜¯ `""`ï¼Œåˆ™å°†è¿”å›åŸå¯¹è±¡ï¼Œè¿™ä¸€ç‚¹ä¸ `+` æˆªç„¶ä¸åŒï¼š

    ```java
    // Source Code
    public String concat(String str) {
        int otherLen = str.length();
        if (otherLen == 0) {
            return this;
        }
        int len = value.length;
        char buf[] = Arrays.copyOf(valueï¼Œlen + otherLen);
        str.getChars(bufï¼Œlen);
        return new String(bufï¼Œtrue);
    }
    ```

## 4. å­—ç¬¦ä¸²çš„é•¿åº¦

### 4.1 å­—ç¬¦ä¸²çš„ç¼–ç 

```java
/**
 * ...The Java
 * platform uses the UTF-16 representation in {@code char} arrays and
 * in the {@code String} and {@code StringBuffer} classes...
 */
```

Java ä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯ Unicodeï¼Œæ–‡æ¡£ä¸­å£°åé»˜è®¤ä½¿ç”¨ UTF-16 ç¼–ç æ–¹å¼è§£æ Unicodeï¼Œä½†ç”±äº UTF-16 å­—ç¬¦å›ºå®šå  2 å­—èŠ‚é•¿åº¦ï¼Œå¯¹äºè‹±æ–‡å­—ç¬¦ï¼ˆASCII å­—ç¬¦å  1 å­—èŠ‚ï¼‰è€Œè¨€è¿‡äºå ç”¨ç©ºé—´ï¼Œå› æ­¤ Java ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿé»˜è®¤çš„ç¼–ç æ–¹å¼å¯¹ Unicode è¿›è¡Œè§£æï¼Œä½¿ç”¨éè‹±æ–‡çš„ç³»ç»Ÿå¤§å¤šä½¿ç”¨ UTF-8 ç¼–ç ï¼š

```java
// Test Code
System.out.println(Charset.defaultCharset());

// Output:
UTF-8
```

### 4.2 Unicode

é€šç§°ä¸‡å›½ç ï¼Œé€šè¿‡æ•°å­—ç¼–ç çš„æ–¹å¼æ¥å­˜å‚¨å­—ç¬¦ï¼Œç†è®ºé•¿åº¦ä» 000000 åˆ° 10FFFF å…± 4180000 ï¼ˆ2^20 + 2^16ï¼‰ä¸ªç¼–ç ï¼›

### 4.3 UTF

ï¼ˆUnicode Transformation Formatï¼‰æ˜¯ Unicode ä»æ•°å­—è½¬åŒ–ä¸ºå­—ç¬¦çš„æ–¹æ¡ˆï¼Œè€Œ UTF-8 æ˜¯å…¶ä¸­ä¸€å¥—å¯å˜é•¿åº¦çš„è½¬åŒ–æ–¹æ¡ˆï¼ŒUTF-16 æ˜¯åŒå­—èŠ‚å®šé•¿çš„è½¬åŒ–æ–¹æ¡ˆï¼›è¿™å°±è¡¨æ˜äº†ï¼Œå¯¹äºè‹±æ–‡å­—ç¬¦ï¼ŒUTF-8 å°†ä»…å ç”¨å•å­—èŠ‚é•¿åº¦æ¥è¡¨ç¤ºï¼Œå¤§å¤§èŠ‚çœäº†ç©ºé—´ã€‚

### 4.4 UTF-8 è½¬æ¢è§„åˆ™

* å¦‚æœåªæœ‰ä¸€ä¸ªå­—èŠ‚åˆ™å…¶æœ€é«˜äºŒè¿›åˆ¶ä½ä¸º0ï¼›

* å¦‚æœæ˜¯å¤šå­—èŠ‚ï¼Œå…¶ç¬¬ä¸€ä¸ªå­—èŠ‚ä»æœ€é«˜ä½å¼€å§‹ï¼Œè¿ç»­çš„äºŒè¿›åˆ¶ä½å€¼ä¸º1çš„ä¸ªæ•°å†³å®šäº†å…¶ç¼–ç çš„å­—èŠ‚æ•°ï¼Œå…¶ä½™å„å­—èŠ‚å‡ä»¥10å¼€å¤´ã€‚

* UTF-8 è½¬æ¢è¡¨

    Unicode | bit | Unit | UTF-8 | byte
    :-: | :-: | :-: | :-: | :-:
    0000 ~ 007F | 00~07 | 1 | 0XXX XXXX | 1
    0080 ~ 07FF | 08~11 | 1 | 110X XXXX<br/>10XX XXXX | 2
    0800 ~ FFFF | 12~16 | 1 | 110X XXXX<br/>10XX XXXX<br/>10XX XXXX | 3
    01 0000 ~ 10 FFFF | 17~21 | 2~n | 110X XXXX<br/>10XX XXXX<br/>10XX XXXX<br/>10XX XXXX | 4

### 4.5 å­—ç¬¦é•¿åº¦ä¸å­—ç¬¦ä¸²é•¿åº¦

å¦‚æœç³»ç»Ÿé‡‡ç”¨çš„ç¼–ç æ–¹å¼æ˜¯ UTF-8ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ çš„å­—ç¬¦ä¸²çš„é•¿åº¦ä¼šå˜æ¥å˜å»ï¼›è¿™æ˜¯ç”±äº UTF-8 æ˜¯å¯å˜é•¿çš„ç¼–ç æ–¹å¼æ‰€å†³å®šçš„ï¼š

```java
// Test Code
String string;
string = "ab";
getStringInfo(string);
string = "ä½ å¥½";
getStringInfo(string);
string = "ğ¡ƒğ¡ƒ";
getStringInfo(string);
string = "ğŸ‘¦ğŸ‘©";
getStringInfo(string);
string = "ğŸ‘½ğŸ‘½â€";
getStringInfo(string);

...
private static void getStringInfo(String string) {
    System.out.println(string + ".length\t\t\t\t= " + string.length());
    System.out.println(string + ".toCharArray.length\t= " + string.toCharArray().length);
    System.out.println(string + ".getBytes.length\t= " + string.getBytes().length);
}

// Output:
ab.length = 2
ab.toCharArray.length = 2
ab.getBytes.length = 2
ä½ å¥½.length = 2
ä½ å¥½.toCharArray.length = 2
ä½ å¥½.getBytes.lengt = 6
ğ¡ƒğ¡ƒ.length = 4
ğ¡ƒğ¡ƒ.toCharArray.length = 4
ğ¡ƒğ¡ƒ.getBytes.length = 8
ğŸ‘¦ğŸ‘©.length = 4
ğŸ‘¦ğŸ‘©.toCharArray.length = 4
ğŸ‘¦ğŸ‘©.getBytes.length = 8
ğŸ‘½ğŸ‘½.length = 5
ğŸ‘½ğŸ‘½.toCharArray.length = 5
ğŸ‘½ğŸ‘½.getBytes.length = 11
```

* `String.length()` æ–¹æ³•è¿”å›çš„æ˜¯ Unicode å•å…ƒçš„é•¿åº¦

* `String.toCharArray.length()` String æœ¬æ¥å°±æ˜¯ Char æ•°ç»„ï¼ŒåŒæ ·æ˜¯ Unicode å•å…ƒçš„é•¿åº¦

* `String.getBytes.length()` æ–¹æ³•å°†è¿”å› UTF-8 ç¼–ç çš„å­—èŠ‚æ•°ç»„é•¿åº¦

ç›®å‰çš„ Unicode å­—ç¬¦åˆ†ä¸º17ç»„ç¼–æ’ï¼Œ0x0000 è‡³ 0x10FFFFï¼Œæ¯ç»„ç§°ä¸ºå¹³é¢ï¼ˆPlaneï¼‰ï¼Œè€Œæ¯å¹³é¢æ‹¥æœ‰FFFF(65536) ä¸ªç ä½ã€‚æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„å­—ç¬¦åŸºæœ¬ä¸Šéƒ½åœ¨ BMP(Basic Multilingual Planeï¼ŒåŸºæœ¬å¤šè¯­è¨€å¹³é¢) ä¸­ï¼Œå³ Plane 0ï¼ŒèŒƒå›´ä¸ºï¼š0000 ~ FFFF å…± 65536 ä¸ªå­—ç¬¦ï¼Œå  1 ä¸ª Unicode å•å…ƒï¼Œä»è½¬æ¢è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œå…¶ UTF-8 ç¼–ç å  1~3 ä¸ª bit é•¿åº¦ã€‚

å› æ­¤ï¼Œä¸Šä¾‹å­ä¸­çš„ `ğ¡ƒğ¡ƒ`ã€`ğŸ‘¦ğŸ‘©`ã€`ğŸ‘½ğŸ‘½â€` ç”±äºæ˜¯ Unicode 3.0 ååŠ å…¥çš„å­—ç¬¦ï¼Œæ—©å·²è¶…å‡º BMP æ‰€èƒ½è¡¨ç¤ºçš„å­—ç¬¦ï¼Œå› æ­¤éœ€è¦å ç”¨ 2 ä¸ªåŠä»¥ä¸Šçš„ Unicode å•å…ƒï¼Œå› æ­¤æ‰€æ±‚å¾—çš„å­—ç¬¦ä¸²é•¿åº¦ä¼šå’Œæ˜¾ç¤ºçš„å­—ç¬¦é•¿åº¦ä¸ä¸€è‡´ï¼Œè¿™æ˜¯ä¸€ä¸ªå‘ï¼

è€Œç”±äº UTF-8 æ˜¯å˜é•¿ç¼–ç ï¼ŒByte æ•°ç»„é•¿åº¦ä¸ä¸€åˆ™æ˜¯å¾ˆæ­£å¸¸çš„è¡¨ç°äº†ã€‚

è€Œå¦‚æœéœ€è¦è·å–ä¸å®é™…ç›¸æ¯”è¾ƒç²¾å‡†çš„å­—ç¬¦æ•°é‡ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `String.codePotinCount` æ–¹æ³•ï¼š

```java
// Test Code
string = "ab";
System.out.println(string.codePointCount(0, string.length()));
string = "ä½ å¥½";
System.out.println(string.codePointCount(0, string.length()));
string = "ğ¡ƒğ¡ƒ";
System.out.println(string.codePointCount(0, string.length()));
string = "ğŸ‘¦ğŸ‘©";
System.out.println(string.codePointCount(0, string.length()));
string = "ğŸ‘½ğŸ‘½â€";
System.out.println(string.codePointCount(0, string.length()));

// Output:
2
2
2
2
3
```

è‡³äº... æœ€åä¸€ä¸ªæ˜¯æ€ä¹ˆå›äº‹ï¼Œæˆ‘è‡³ä»Šæ²¡ææ‡‚...

![å¥‡æ€ªçš„emoji](/images/posts/string/1.png)

ç«Ÿç„¶æ˜¯äº”ï¼Ÿï¼Ÿï¼Ÿ

## 5. hashCode() çš„é­”æ³•å€¼

åœ¨ä¸Šæ–‡ [Stringçš„å”¯ä¸€æ€§åˆ¤æ–­](#Stringçš„å”¯ä¸€æ€§åˆ¤æ–­) ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ hashCode() æ–¹æ³•åˆ¤æ–­å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸åŒï¼Œä½†åœ¨å“ˆå¸Œå‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ä¹˜å­ï¼š31

```java
/** The value is used for character storage. */
private final char value[];

/** Cache the hash code for the string */
private int hash; // Default to 0

/**
 * Returns a hash code for this string. The hash code for a
 * {@code String} object is computed as
 * <blockquote><pre>
 * s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]
 * </pre></blockquote>
 * using {@code int} arithmeticï¼Œwhere {@code s[i]} is the
 * <i>i</i>th character of the stringï¼Œ{@code n} is the length of
 * the stringï¼Œand {@code ^} indicates exponentiation.
 * (The hash value of the empty string is zero.)
 *
 * @return  a hash code value for this object.
 */
public int hashCode() {
    int h = hash;
    if (h == 0 && value.length > 0) {
        char val[] = value;

        for (int i = 0; i < value.length; i++) {
            h = 31 * h + val[i];
        }
        hash = h;
    }
    return h;
}
```

æ–‡æ¡£ä¸­ç»™å‡ºäº†è¿™ä¸ªå“ˆå¸Œå‡½æ•°çš„ç®—æ³•ï¼Œé€šè¿‡æ¨å¯¼æ£€éªŒç®—æ³•ï¼š

```java
// s = val; n = length
s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]

// Check
length=1 -> h = 31 * 0 + val[0]
              = val[0]

length=2 -> h = 31 * (31 * 0 + val[0]) + val[1]
              = 31 * val[0] + val[1]
              = val[0] * 31^(2-1) + val[1]

length=3 -> h = 31 * (31 * (31 * 0 + val[0]) + val[1]) + val[2]
              = 31 * 31 * val[0] + 31 * val[1] + val[2]
              = val[0] * 31^(3-1) + val[1] * 31^(3-2) + val[2]

length=n -> h = val[0] * 31^(n-1) + val[1] * 31^(n-2) + ... + val[n-1]
```

å°†å“ˆå¸Œç®—æ³•å†™æˆæ•°å­¦å…¬å¼ä¸ºï¼š

$$hash = \sum_{i=0}^{n-1}value[i]\ *\ 31^{n-1-i}$$

è€Œç”±äºæ•´å‹çš„æ•°å€¼è¾¹ç•Œæ˜¯ $$ 2^{31} $$ ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯ï¼š

$$hash = \sum_{i=0}^{n-1}value[i]31^{n-1-i} \quad Mod \quad 2^{31} $$


31 æœ‰ä»¥ä¸‹å‡ ä¸ªæ€§è´¨ï¼š

* 31 æ˜¯ä¸€ä¸ªè´¨æ•°

* 31 = $$ 2^{5} - 1$$

ç”±äº 31 æ‰€å…·å¤‡çš„æ€§è´¨ï¼Œä»¥ä¸‹è§£é‡Šä¹˜å­é‡‡ç”¨ 31 çš„åŸå› ï¼š

1. å“ˆå¸Œç®—æ³•æ‰€é‡‡ç”¨çš„æ¨¡æˆ–è€…æ˜¯ä¹˜å­é‡‡ç”¨è´¨æ•°èƒ½å¤Ÿæœ‰æ•ˆåœ°å‡å°ç¢°æ’ï¼Œå‚è€ƒ [å“ˆå¸Œè¡¨çš„å¤§å°ä¸ºä»€ä¹ˆæœ€å¥½æ˜¯ç´ æ•°](https://blog.csdn.net/maoliran/article/details/52082829)

2. ç”±äºå®ƒçš„ç¬¬äºŒä¸ªæ€§è´¨ï¼ŒJVM è‡ªåŠ¨å¯¹å®ƒè¿›è¡Œäº†ä¼˜åŒ–ï¼š

    ```java
    // 31 = 2^5 - 1
    31 * i == i * (2^5 - 1) == i << 5 - i
    ```

    ç§»ä½è¿ç®—å¤§å¤§æé«˜äº†å¾ªç¯è¿ç®—çš„æ•ˆç‡

3. value[n] æ˜¯å­—ç¬¦ä¸²ä¸­å­—ç¬¦æ‰€åœ¨çš„ Unicode å¹³é¢çš„ç¼–å·ï¼ŒèŒƒå›´ä» 0 åˆ° 65536ï¼›å¤ªå°çš„è´¨æ•°è¿›è¡Œå“ˆå¸Œè¿ç®—ç¢°æ’ç‡ä¼šæé«˜ï¼Œè€Œå¤ªå¤§çš„è´¨æ•°è¿›è¡Œå“ˆå¸Œè¿ç®—å¯¼è‡´è¿ç®—æˆæœ¬é™¡å¢ï¼Œå› æ­¤å¿…é¡»é€‰ç”¨é€‚ä¸­çš„è´¨æ•°ï¼Œè€Œç”±äº 31 å­˜åœ¨ä¼˜åŒ–ä¸”ç¢°æ’ç‡å¹¶ä¸ç®—é«˜ï¼Œå› æ­¤é€‰ç”¨ 31 ä½œä¸ºä¹˜å­

    ![å¥‡æ€ªçš„emoji2](/images/posts/string/2.png)

å‚è€ƒï¼š

* [å“ˆå¸Œè¡¨çš„å¤§å°ä¸ºä»€ä¹ˆæœ€å¥½æ˜¯ç´ æ•°](https://blog.csdn.net/maoliran/article/details/52082829)
* [ç§‘æ™®ï¼šä¸ºä»€ä¹ˆString hashCode å‡½æ•°ä½¿ç”¨ 31 ä½œä¸ºä¹˜å­](https://segmentfault.com/a/1190000010799123)
* [ä¸€ä¸ªJavaå­—ç¬¦ä¸²ä¸­åˆ°åº•æœ‰å¤šå°‘ä¸ªå­—ç¬¦?](https://colobu.com/2019/01/04/how-many-charactors-in-a-java-string/)
